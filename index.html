<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario Pro con Sesiones</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        /* Estilos Generales */
        :root { --primary: #2563eb; --success: #16a34a; --danger: #dc2626; --bg: #f1f5f9; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); margin: 0; padding: 0; }
        .container { max-width: 600px; margin: 0 auto; padding: 15px; }
        
        /* Tarjetas */
        .card { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 15px; }
        h2 { margin-top: 0; color: #1e293b; font-size: 1.25rem; }
        
        /* Botones */
        button { width: 100%; padding: 12px; margin-bottom: 8px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: 0.2s; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-success { background-color: var(--success); color: white; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-outline { background-color: transparent; border: 2px solid #cbd5e1; color: #475569; }
        
        /* Inputs */
        input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #cbd5e1; border-radius: 8px; box-sizing: border-box; }
        label { font-weight: 600; font-size: 0.9rem; color: #475569; display: block; margin-bottom: 4px; }

        /* Lista de Sesiones */
        .session-item { border-bottom: 1px solid #e2e8f0; padding: 10px 0; display: flex; justify-content: space-between; align-items: center; }
        .session-info h3 { margin: 0; font-size: 1rem; }
        .session-info p { margin: 0; font-size: 0.8rem; color: #64748b; }

        /* Tabla dentro de sesi√≥n */
        .scan-list { list-style: none; padding: 0; margin: 0; }
        .scan-item { background: #f8fafc; border-left: 4px solid var(--primary); padding: 10px; margin-bottom: 8px; border-radius: 4px; }
        .scan-item strong { display: block; }
        .scan-item span { font-size: 0.85rem; color: #64748b; }

        /* Pantallas (Navegaci√≥n) */
        .screen { display: none; }
        .active { display: block; }

        #reader { width: 100%; border-radius: 8px; overflow: hidden; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">

    <div id="screen-home" class="screen active">
        <div class="card" style="text-align: center;">
            <h2>üìÇ Mis Sesiones de Inventario</h2>
            <button class="btn-primary" onclick="crearNuevaSesion()">+ Nueva Sesi√≥n</button>
            <button class="btn-danger" onclick="borrarTodoElSistema()" style="font-size: 0.8rem; margin-top:10px">‚ö†Ô∏è Formatear Datos</button>
        </div>

        <div class="card">
            <h3>Historial</h3>
            <div id="listaSesiones">
                <p style="text-align:center; color:#999">No hay sesiones guardadas.</p>
            </div>
        </div>
    </div>

    <div id="screen-scanner" class="screen">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h2 id="tituloSesionActual">Sesi√≥n Actual</h2>
                <button class="btn-outline" style="width:auto; padding: 5px 10px;" onclick="irAHome()">üè† Salir</button>
            </div>
            
            <button id="btnCamara" class="btn-primary" onclick="toggleCamara()">üì∏ Activar C√°mara</button>
            <div id="reader"></div>

            <label>C√≥digo:</label>
            <input type="text" id="inpCodigo" placeholder="Escanea o escribe..." autofocus onchange="buscarProductoConocido()">
            
            <div style="display:flex; gap:10px;">
                <div style="flex:1">
                    <label>Nombre:</label>
                    <input type="text" id="inpNombre" placeholder="Producto...">
                </div>
                <div style="flex:1">
                    <label>Ubicaci√≥n:</label>
                    <input type="text" id="inpUbi" placeholder="Estante A...">
                </div>
            </div>

            <button class="btn-success" onclick="guardarEscaneo()">üíæ Agregar a Lista</button>
        </div>

        <div class="card">
            <h3>üì¶ Elementos en esta sesi√≥n (<span id="contadorItems">0</span>)</h3>
            <button class="btn-outline" onclick="exportarSesionExcel()">üì• Exportar esta sesi√≥n a Excel</button>
            <ul id="listaItemsActual" class="scan-list">
                </ul>
        </div>
    </div>

</div>

<script>
    // === VARIABLES GLOBALES ===
    let catalogoProductos = JSON.parse(localStorage.getItem('catalogoProductos')) || {}; 
    let sesiones = JSON.parse(localStorage.getItem('sesiones')) || [];
    let sesionActualId = null;
    let scannerObj = null;
    let camaraActiva = false;

    // === NAVEGACI√ìN ===
    function irAHome() {
        detenerCamara();
        document.getElementById('screen-home').classList.add('active');
        document.getElementById('screen-scanner').classList.remove('active');
        renderizarListaSesiones();
    }

    function irAScanner() {
        document.getElementById('screen-home').classList.remove('active');
        document.getElementById('screen-scanner').classList.add('active');
        limpiarFormulario();
    }

    // === GESTI√ìN DE SESIONES ===
    function crearNuevaSesion() {
        const nombre = prompt("Nombre para esta sesi√≥n de inventario:", "Inventario " + new Date().toLocaleDateString());
        if (!nombre) return;

        const nuevaSesion = {
            id: Date.now(), // ID √∫nico basado en la hora
            nombre: nombre,
            fecha: new Date().toLocaleString(),
            items: []
        };

        sesiones.unshift(nuevaSesion); // Agregar al principio
        guardarSesiones();
        abrirSesion(nuevaSesion.id);
    }

    function abrirSesion(id) {
        sesionActualId = id;
        const sesion = sesiones.find(s => s.id === id);
        if(!sesion) return;

        document.getElementById('tituloSesionActual').innerText = sesion.nombre;
        renderizarItemsSesion();
        irAScanner();
    }

    function guardarSesiones() {
        localStorage.setItem('sesiones', JSON.stringify(sesiones));
    }

    function renderizarListaSesiones() {
        const div = document.getElementById('listaSesiones');
        if (sesiones.length === 0) {
            div.innerHTML = '<p style="text-align:center; color:#999">No hay sesiones guardadas.</p>';
            return;
        }
        
        let html = '';
        sesiones.forEach(s => {
            html += `
            <div class="session-item">
                <div class="session-info">
                    <h3>${s.nombre}</h3>
                    <p>${s.fecha} - ${s.items.length} productos</p>
                </div>
                <div>
                    <button class="btn-primary" style="width:auto; padding:5px 10px; font-size:0.8rem" onclick="abrirSesion(${s.id})">Abrir</button>
                    <button class="btn-danger" style="width:auto; padding:5px 10px; font-size:0.8rem" onclick="borrarSesion(${s.id})">X</button>
                </div>
            </div>`;
        });
        div.innerHTML = html;
    }

    function borrarSesion(id) {
        if(!confirm("¬øBorrar esta sesi√≥n?")) return;
        sesiones = sesiones.filter(s => s.id !== id);
        guardarSesiones();
        renderizarListaSesiones();
    }

    // === L√ìGICA DE ESCANEO Y PRODUCTOS ===
    
    // Al escribir o escanear un c√≥digo, ver si ya lo conocemos de antes
    function buscarProductoConocido() {
        const codigo = document.getElementById('inpCodigo').value.trim();
        if (catalogoProductos[codigo]) {
            // ¬°Lo conocemos! Rellenar datos
            document.getElementById('inpNombre').value = catalogoProductos[codigo].nombre;
            document.getElementById('inpUbi').value = catalogoProductos[codigo].ubicacion;
        }
    }

    function guardarEscaneo() {
        const codigo = document.getElementById('inpCodigo').value.trim();
        const nombre = document.getElementById('inpNombre').value.trim();
        const ubi = document.getElementById('inpUbi').value.trim();

        if (!codigo) { alert("El c√≥digo es obligatorio"); return; }

        // 1. Guardar o Actualizar en el Cat√°logo Global (Para el futuro)
        catalogoProductos[codigo] = { nombre, ubicacion: ubi };
        localStorage.setItem('catalogoProductos', JSON.stringify(catalogoProductos));

        // 2. Guardar en la Sesi√≥n Actual
        const item = {
            codigo, nombre, ubi, 
            hora: new Date().toLocaleTimeString() 
        };

        const index = sesiones.findIndex(s => s.id === sesionActualId);
        if (index !== -1) {
            sesiones[index].items.unshift(item); // Agregar al inicio de la lista
            guardarSesiones();
            renderizarItemsSesion();
            limpiarFormulario();
            
            // Feedback visual (parpadeo verde en el borde)
            document.getElementById('inpCodigo').style.borderColor = "green";
            setTimeout(() => document.getElementById('inpCodigo').style.borderColor = "#cbd5e1", 500);
        }
    }

    function renderizarItemsSesion() {
        const sesion = sesiones.find(s => s.id === sesionActualId);
        const ul = document.getElementById('listaItemsActual');
        document.getElementById('contadorItems').innerText = sesion.items.length;
        
        let html = '';
        sesion.items.forEach(item => {
            html += `
            <li class="scan-item">
                <strong>${item.nombre || 'Sin nombre'} (${item.codigo})</strong>
                <span>üìç ${item.ubi || 'Sin ubicaci√≥n'} | ‚è∞ ${item.hora}</span>
            </li>`;
        });
        ul.innerHTML = html;
    }

    function limpiarFormulario() {
        document.getElementById('inpCodigo').value = '';
        document.getElementById('inpNombre').value = '';
        // Nota: NO limpiamos ubicaci√≥n porque usualmente escaneas varios en el mismo estante.
        // Si quieres limpiar ubicaci√≥n tambi√©n, descomenta la siguiente l√≠nea:
        // document.getElementById('inpUbi').value = ''; 
        document.getElementById('inpCodigo').focus();
    }

    // === C√ÅMARA (Igual que antes) ===
    function toggleCamara() {
        if(camaraActiva) {
            detenerCamara();
        } else {
            document.getElementById('reader').style.display = "block";
            scannerObj = new Html5Qrcode("reader");
            scannerObj.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
                (decodedText) => {
                    document.getElementById('inpCodigo').value = decodedText;
                    buscarProductoConocido(); // Auto-rellenar si existe
                    // detenerCamara(); // Descomentar si quieres que cierre tras escanear
                    
                    // Sonido Beep simple (opcional)
                    // new Audio('beep.mp3').play().catch(e=>{}); 
                }
            );
            camaraActiva = true;
            document.getElementById('btnCamara').innerText = "‚ùå Detener C√°mara";
            document.getElementById('btnCamara').classList.replace('btn-primary', 'btn-danger');
        }
    }

    function detenerCamara() {
        if(scannerObj) {
            scannerObj.stop().then(() => {
                document.getElementById('reader').style.display = "none";
                scannerObj.clear();
            });
        }
        camaraActiva = false;
        document.getElementById('btnCamara').innerText = "üì∏ Activar C√°mara";
        document.getElementById('btnCamara').classList.replace('btn-danger', 'btn-primary');
    }

    // === EXPORTAR EXCEL ===
    function exportarSesionExcel() {
        const sesion = sesiones.find(s => s.id === sesionActualId);
        if (!sesion || sesion.items.length === 0) { alert("Nada que exportar"); return; }

        let csv = "\uFEFFHora,Codigo,Nombre,Ubicacion\n";
        sesion.items.forEach(i => {
            csv += `"${i.hora}","${i.codigo}","${i.nombre}","${i.ubi}"\n`;
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `Inventario_${sesion.nombre}.csv`;
        link.click();
    }

    function borrarTodoElSistema() {
        if(confirm("ESTO BORRAR√Å TODAS LAS SESIONES Y EL CAT√ÅLOGO DE PRODUCTOS. ¬øSeguro?")) {
            localStorage.clear();
            location.reload();
        }
    }

    // Inicializar
    renderizarListaSesiones();

</script>
</body>
</html>
