<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario Pro V3</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        /* Estilos Generales */
        :root { --primary: #2563eb; --success: #16a34a; --danger: #dc2626; --bg: #f1f5f9; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); margin: 0; padding: 0; }
        .container { max-width: 600px; margin: 0 auto; padding: 15px; }
        
        /* Tarjetas */
        .card { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 15px; }
        h2 { margin-top: 0; color: #1e293b; font-size: 1.25rem; }
        
        /* Botones */
        button { width: 100%; padding: 12px; margin-bottom: 8px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: 0.2s; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-success { background-color: var(--success); color: white; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-outline { background-color: transparent; border: 2px solid #cbd5e1; color: #475569; }
        
        /* Inputs */
        input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #cbd5e1; border-radius: 8px; box-sizing: border-box; }
        label { font-weight: 600; font-size: 0.9rem; color: #475569; display: block; margin-bottom: 4px; }

        /* Lista de Sesiones */
        .session-item { border-bottom: 1px solid #e2e8f0; padding: 10px 0; display: flex; justify-content: space-between; align-items: center; }
        .session-info h3 { margin: 0; font-size: 1rem; }
        .session-info p { margin: 0; font-size: 0.8rem; color: #64748b; }

        /* Tabla dentro de sesi√≥n */
        .scan-list { list-style: none; padding: 0; margin: 0; }
        .scan-item { background: #f8fafc; border-left: 4px solid var(--primary); padding: 10px; margin-bottom: 8px; border-radius: 4px; }
        .scan-item strong { display: block; }
        .scan-item span { font-size: 0.85rem; color: #64748b; }

        /* Pantallas (Navegaci√≥n) */
        .screen { display: none; }
        .active { display: block; }

        #reader { width: 100%; border-radius: 8px; overflow: hidden; margin-bottom: 10px; display:none; }
    </style>
</head>
<body>

<div class="container">

    <div id="screen-home" class="screen active">
        <div class="card" style="text-align: center;">
            <h2>üìÇ Mis Sesiones</h2>
            <button class="btn-primary" onclick="crearNuevaSesion()">+ Nueva Sesi√≥n</button>
            <button class="btn-danger" onclick="borrarTodoElSistema()" style="font-size: 0.8rem; margin-top:10px">‚ö†Ô∏è Formatear Datos</button>
        </div>

        <div class="card">
            <h3>Historial</h3>
            <div id="listaSesiones">
                <p style="text-align:center; color:#999">No hay sesiones guardadas.</p>
            </div>
        </div>
    </div>

    <div id="screen-scanner" class="screen">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h2 id="tituloSesionActual">Sesi√≥n Actual</h2>
                <button class="btn-outline" style="width:auto; padding: 5px 10px;" onclick="irAHome()">üè† Salir</button>
            </div>
            
            <button id="btnCamara" class="btn-primary" onclick="toggleCamara()">üì∏ Activar C√°mara</button>
            <div id="reader"></div>

            <label>C√≥digo (codigo_bien):</label>
            <input type="text" id="inpCodigo" placeholder="Escanea o escribe..." autofocus onchange="buscarProductoConocido()">
            
            <div style="display:flex; gap:10px;">
                <div style="flex:1">
                    <label>Nombre (denominacion_bien):</label>
                    <input type="text" id="inpNombre" placeholder="Producto...">
                </div>
                <div style="flex:1">
                    <label>Ubicaci√≥n (ubicacion):</label>
                    <input type="text" id="inpUbi" placeholder="Estante A...">
                </div>
            </div>

            <button class="btn-success" onclick="guardarEscaneo()">üíæ Guardar</button>
        </div>

        <div class="card">
            <h3>üì¶ Lista (<span id="contadorItems">0</span>)</h3>
            <button class="btn-outline" onclick="exportarSesionExcel()">üì• Exportar Excel (CSV)</button>
            <ul id="listaItemsActual" class="scan-list"></ul>
        </div>
    </div>

</div>

<script>
    // === VARIABLES GLOBALES ===
    let catalogoProductos = JSON.parse(localStorage.getItem('catalogoProductos')) || {}; 
    let sesiones = JSON.parse(localStorage.getItem('sesiones')) || [];
    let sesionActualId = null;
    let scannerObj = null;
    let camaraActiva = false;

    // === NAVEGACI√ìN Y CORRECCI√ìN DE BUG DE C√ÅMARA ===
    async function irAHome() {
        if (camaraActiva) {
            try {
                await detenerCamara();
            } catch (error) {
                console.log("Forzando salida...");
            }
        }
        document.getElementById('screen-home').classList.add('active');
        document.getElementById('screen-scanner').classList.remove('active');
        renderizarListaSesiones();
    }

    function irAScanner() {
        document.getElementById('screen-home').classList.remove('active');
        document.getElementById('screen-scanner').classList.add('active');
        limpiarFormulario();
    }

    // === GESTI√ìN DE SESIONES ===
    function crearNuevaSesion() {
        const nombre = prompt("Nombre para esta sesi√≥n:", "Inventario " + new Date().toLocaleDateString());
        if (!nombre) return;

        const nuevaSesion = {
            id: Date.now(),
            nombre: nombre,
            fecha: new Date().toLocaleString(),
            items: []
        };

        sesiones.unshift(nuevaSesion);
        guardarSesiones();
        abrirSesion(nuevaSesion.id);
    }

    function abrirSesion(id) {
        sesionActualId = id;
        const sesion = sesiones.find(s => s.id === id);
        if(!sesion) return;

        document.getElementById('tituloSesionActual').innerText = sesion.nombre;
        renderizarItemsSesion();
        irAScanner();
    }

    function guardarSesiones() {
        localStorage.setItem('sesiones', JSON.stringify(sesiones));
    }

    function renderizarListaSesiones() {
        const div = document.getElementById('listaSesiones');
        if (sesiones.length === 0) {
            div.innerHTML = '<p style="text-align:center; color:#999">No hay sesiones guardadas.</p>';
            return;
        }
        
        let html = '';
        sesiones.forEach(s => {
            html += `
            <div class="session-item">
                <div class="session-info">
                    <h3>${s.nombre}</h3>
                    <p>${s.fecha} - ${s.items.length} items</p>
                </div>
                <div>
                    <button class="btn-primary" style="width:auto; padding:5px 10px; font-size:0.8rem" onclick="abrirSesion(${s.id})">Abrir</button>
                    <button class="btn-danger" style="width:auto; padding:5px 10px; font-size:0.8rem" onclick="borrarSesion(${s.id})">X</button>
                </div>
            </div>`;
        });
        div.innerHTML = html;
    }

    function borrarSesion(id) {
        if(!confirm("¬øBorrar esta sesi√≥n?")) return;
        sesiones = sesiones.filter(s => s.id !== id);
        guardarSesiones();
        renderizarListaSesiones();
    }

    // === L√ìGICA DE ESCANEO ===
    function buscarProductoConocido() {
        const codigo = document.getElementById('inpCodigo').value.trim();
        if (catalogoProductos[codigo]) {
            document.getElementById('inpNombre').value = catalogoProductos[codigo].nombre;
            document.getElementById('inpUbi').value = catalogoProductos[codigo].ubicacion;
        }
    }

    function guardarEscaneo() {
        const codigo = document.getElementById('inpCodigo').value.trim();
        const nombre = document.getElementById('inpNombre').value.trim();
        const ubi = document.getElementById('inpUbi').value.trim();

        if (!codigo) { alert("El c√≥digo es obligatorio"); return; }

        // Guardar en memoria global
        catalogoProductos[codigo] = { nombre, ubicacion: ubi };
        localStorage.setItem('catalogoProductos', JSON.stringify(catalogoProductos));

        // Guardar en sesi√≥n
        const item = { codigo, nombre, ubi, hora: new Date().toLocaleTimeString() };

        const index = sesiones.findIndex(s => s.id === sesionActualId);
        if (index !== -1) {
            sesiones[index].items.unshift(item);
            guardarSesiones();
            renderizarItemsSesion();
            limpiarFormulario();
            
            // Feedback visual
            const input = document.getElementById('inpCodigo');
            input.style.backgroundColor = "#dcfce7";
            setTimeout(() => input.style.backgroundColor = "white", 500);
        }
    }

    function renderizarItemsSesion() {
        const sesion = sesiones.find(s => s.id === sesionActualId);
        const ul = document.getElementById('listaItemsActual');
        document.getElementById('contadorItems').innerText = sesion.items.length;
        
        let html = '';
        sesion.items.forEach(item => {
            html += `
            <li class="scan-item">
                <strong>${item.nombre || 'Sin nombre'}</strong>
                <span>${item.codigo} | ${item.ubi || 'Sin ubicaci√≥n'}</span>
            </li>`;
        });
        ul.innerHTML = html;
    }

    function limpiarFormulario() {
        document.getElementById('inpCodigo').value = '';
        document.getElementById('inpNombre').value = '';
        document.getElementById('inpCodigo').focus();
    }

    // === C√ÅMARA MEJORADA ===
    function toggleCamara() {
        if(camaraActiva) {
            detenerCamara();
        } else {
            document.getElementById('reader').style.display = "block";
            scannerObj = new Html5Qrcode("reader");
            scannerObj.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
                (decodedText) => {
                    document.getElementById('inpCodigo').value = decodedText;
                    buscarProductoConocido();
                    // Opcional: Auto-guardar descomentando la linea de abajo
                    // guardarEscaneo();
                }
            ).catch(err => alert("Error c√°mara: " + err));
            
            camaraActiva = true;
            const btn = document.getElementById('btnCamara');
            btn.innerText = "‚ùå Detener C√°mara";
            btn.classList.replace('btn-primary', 'btn-danger');
        }
    }

    function detenerCamara() {
        if (!scannerObj || !camaraActiva) return Promise.resolve();
        return scannerObj.stop().then(() => {
            document.getElementById('reader').style.display = "none";
            scannerObj.clear();
            camaraActiva = false;
            const btn = document.getElementById('btnCamara');
            btn.innerText = "üì∏ Activar C√°mara";
            btn.classList.replace('btn-danger', 'btn-primary');
        }).catch(err => {
            console.warn("Error deteniendo c√°mara", err);
            camaraActiva = false;
            document.getElementById('reader').style.display = "none";
        });
    }

    // === EXPORTAR EXCEL (MODIFICADO) ===
    function exportarSesionExcel() {
        const sesion = sesiones.find(s => s.id === sesionActualId);
        if (!sesion || sesion.items.length === 0) { alert("Nada que exportar"); return; }

        // AQU√ç EST√ÅN TUS NOMBRES PERSONALIZADOS
        let csv = "\uFEFFcodigo_bien,denominacion_bien,ubicacion\n";
        
        sesion.items.forEach(i => {
            // Aseguramos que los valores existan y ponemos comillas por si tienen espacios
            csv += `"${i.codigo}","${i.nombre}","${i.ubi}"\n`;
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `${sesion.nombre}.csv`;
        link.click();
    }

    function borrarTodoElSistema() {
        if(confirm("ESTO BORRAR√Å TODO. ¬øSeguro?")) {
            localStorage.clear();
            location.reload();
        }
    }

    renderizarListaSesiones();
</script>
</body>
</html>
